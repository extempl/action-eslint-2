"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const path_1 = require("path");
const github_1 = require("@actions/github");
const core_1 = require("@actions/core");
const { GITHUB_TOKEN, GITHUB_SHA, GITHUB_WORKSPACE } = process.env;
const ACTION_NAME = 'ESLint';
const EXTENSIONS = new Set(['.ts', '.js', '.tsx', '.jsx']);
async function lint(files) {
    const { CLIEngine } = await Promise.resolve().then(() => require(path_1.join(process.cwd(), 'node_modules/eslint')));
    const cli = new CLIEngine({
        extensions: [...EXTENSIONS],
        ignorePath: '.gitignore'
    });
    const report = cli.executeOnFiles(files || ['src']);
    const { results, errorCount, warningCount } = report;
    const levels = ['notice', 'warning', 'failure'];
    const annotations = [];
    const consoleOutput = [];
    const consoleLevels = [, 'warning', 'error'];
    for (const res of results) {
        const { filePath, messages } = res;
        const path = filePath.substring(GITHUB_WORKSPACE.length + 1);
        for (const msg of messages) {
            const { line, endLine, column, endColumn, severity, ruleId, message } = msg;
            const annotationLevel = levels[severity];
            const consoleLevel = consoleLevels[severity];
            annotations.push({
                path,
                start_line: line,
                end_line: endLine || line,
                start_column: column,
                end_column: endColumn || column,
                annotation_level: annotationLevel,
                title: ruleId || ACTION_NAME,
                message: `${message}${ruleId ? `\nhttps://eslint.org/docs/rules/${ruleId}` : ''}`
            });
            consoleOutput.push(`${path}\n`);
            consoleOutput.push(`##[${consoleLevel}]  ${line}:${column}  ${consoleLevel}  ${message}  ${ruleId}\n\n`);
        }
    }
    console.log(consoleOutput.join(''));
    return {
        conclusion: errorCount > 0 ? 'failure' : 'success',
        output: {
            title: ACTION_NAME,
            summary: `${errorCount} error(s), ${warningCount} warning(s) found`,
            annotations
        }
    };
}
async function run() {
    const octokit = new github_1.GitHub(GITHUB_TOKEN);
    let currentSha;
    let info;
    let lintFiles;
    if (github_1.context.issue && github_1.context.issue.number) {
        info = await octokit.graphql(`query($owner: String!, $name: String!, $prNumber: Int!) {
			repository(owner: $owner, name: $name) {
				pullRequest(number: $prNumber) {
					files(first: 100) {
						nodes {
							path
						}
					}
					commits(last: 1) {
						nodes {
							commit {
								oid
							}
						}
					}
				}
			}
		}`, {
            owner: github_1.context.repo.owner,
            name: github_1.context.repo.repo,
            prNumber: github_1.context.issue.number
        });
        currentSha = info.repository.pullRequest.commits.nodes[0].commit.oid;
        const files = info.repository.pullRequest.files.nodes;
        lintFiles = files.filter((file) => EXTENSIONS.has(path_1.extname(file.path)) && !file.path.includes('.d.ts')).map((f) => f.path);
    }
    else {
        info = await octokit.repos.getCommit({ owner: github_1.context.repo.owner, repo: github_1.context.repo.repo, ref: GITHUB_SHA });
        currentSha = GITHUB_SHA;
        const files = info.data.files;
        lintFiles = files.filter(file => EXTENSIONS.has(path_1.extname(file.filename)) && !file.filename.includes('.d.ts') && file.status !== 'removed' && file.status !== 'changed').map(f => f.filename);
    }
    core_1.debug(`Commit: ${currentSha}`);
    let id;
    const jobName = core_1.getInput('job-name');
    if (jobName) {
        const checks = await octokit.checks.listForRef({
            ...github_1.context.repo,
            status: 'in_progress',
            ref: currentSha
        });
        const check = checks.data.check_runs.find(({ name }) => name.toLowerCase() === jobName.toLowerCase());
        if (check)
            id = check.id;
    }
    if (!id) {
        id = (await octokit.checks.create({
            ...github_1.context.repo,
            name: ACTION_NAME,
            head_sha: currentSha,
            status: 'in_progress',
            started_at: new Date().toISOString()
        })).data.id;
    }
    try {
        const lintAll = core_1.getInput('lint-all');
        const { conclusion, output } = await lint(lintAll ? null : lintFiles);
        await octokit.checks.update({
            ...github_1.context.repo,
            check_run_id: id,
            completed_at: new Date().toISOString(),
            conclusion,
            output
        });
        core_1.debug(output.summary);
        if (conclusion === 'failure')
            core_1.setFailed(output.summary);
    }
    catch (error) {
        await octokit.checks.update({
            ...github_1.context.repo,
            check_run_id: id,
            conclusion: 'failure',
            completed_at: new Date().toISOString()
        });
        core_1.setFailed(error.message);
    }
}
run();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWFpbi5qcyIsInNvdXJjZVJvb3QiOiJzcmMvIiwic291cmNlcyI6WyJtYWluLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsK0JBQXFDO0FBRXJDLDRDQUFrRDtBQUNsRCx3Q0FBMkQ7QUFFM0QsTUFBTSxFQUFFLFlBQVksRUFBRSxVQUFVLEVBQUUsZ0JBQWdCLEVBQUUsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDO0FBRW5FLE1BQU0sV0FBVyxHQUFHLFFBQVEsQ0FBQztBQUM3QixNQUFNLFVBQVUsR0FBRyxJQUFJLEdBQUcsQ0FBQyxDQUFDLEtBQUssRUFBRSxLQUFLLEVBQUUsTUFBTSxFQUFFLE1BQU0sQ0FBQyxDQUFDLENBQUM7QUFFM0QsS0FBSyxVQUFVLElBQUksQ0FBQyxLQUFzQjtJQUN6QyxNQUFNLEVBQUUsU0FBUyxFQUFFLEdBQUcsMkNBQWEsV0FBSSxDQUFDLE9BQU8sQ0FBQyxHQUFHLEVBQUUsRUFBRSxxQkFBcUIsQ0FBQyxFQUE0QixDQUFDO0lBQzFHLE1BQU0sR0FBRyxHQUFHLElBQUksU0FBUyxDQUFDO1FBQ3pCLFVBQVUsRUFBRSxDQUFDLEdBQUcsVUFBVSxDQUFDO1FBQzNCLFVBQVUsRUFBRSxZQUFZO0tBQ3hCLENBQUMsQ0FBQztJQUNILE1BQU0sTUFBTSxHQUFHLEdBQUcsQ0FBQyxjQUFjLENBQUMsS0FBSyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztJQUNwRCxNQUFNLEVBQUUsT0FBTyxFQUFFLFVBQVUsRUFBRSxZQUFZLEVBQUUsR0FBRyxNQUFNLENBQUM7SUFDckQsTUFBTSxNQUFNLEdBQThELENBQUMsUUFBUSxFQUFFLFNBQVMsRUFBRSxTQUFTLENBQUMsQ0FBQztJQUMzRyxNQUFNLFdBQVcsR0FBMEMsRUFBRSxDQUFDO0lBQzlELE1BQU0sYUFBYSxHQUFhLEVBQUUsQ0FBQztJQUNuQyxNQUFNLGFBQWEsR0FBRyxDQUFDLEVBQUUsU0FBUyxFQUFFLE9BQU8sQ0FBQyxDQUFDO0lBQzdDLEtBQUssTUFBTSxH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LEtBQUssU0FBUztZQUFFLGdCQUFTLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDO0tBQ3hEO0lBQUMsT0FBTyxLQUFLLEVBQUU7UUFDZixNQUFNLE9BQU8sQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDO1lBQzNCLEdBQUcsZ0JBQU8sQ0FBQyxJQUFJO1lBQ2YsWUFBWSxFQUFFLEVBQUU7WUFDaEIsVUFBVSxFQUFFLFNBQVM7WUFDckIsWUFBWSxFQUFFLElBQUksSUFBSSxFQUFFLENBQUMsV0FBVyxFQUFFO1NBQ3RDLENBQUMsQ0FBQztRQUNILGdCQUFTLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDO0tBQ3pCO0FBQ0YsQ0FBQztBQUVELEdBQUcsRUFBRSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgam9pbiwgZXh0bmFtZSB9IGZyb20gJ3BhdGgnO1xuaW1wb3J0IHsgQ2hlY2tzVXBkYXRlUGFyYW1zT3V0cHV0QW5ub3RhdGlvbnMsIENoZWNrc0NyZWF0ZVBhcmFtcyB9IGZyb20gJ0BvY3Rva2l0L3Jlc3QnO1xuaW1wb3J0IHsgR2l0SHViLCBjb250ZXh0IH0gZnJvbSAnQGFjdGlvbnMvZ2l0aHViJztcbmltcG9ydCB7IGdldElucHV0LCBzZXRGYWlsZWQsIGRlYnVnIH0gZnJvbSAnQGFjdGlvbnMvY29yZSc7XG5cbmNvbnN0IHsgR0lUSFVCX1RPS0VOLCBHSVRIVUJfU0hBLCBHSVRIVUJfV09SS1NQQUNFIH0gPSBwcm9jZXNzLmVudjtcblxuY29uc3QgQUNUSU9OX05BTUUgPSAnRVNMaW50JztcbmNvbnN0IEVYVEVOU0lPTlMgPSBuZXcgU2V0KFsnLnRzJywgJy5qcycsICcudHN4JywgJy5qc3gnXSk7XG5cbmFzeW5jIGZ1bmN0aW9uIGxpbnQoZmlsZXM6IHN0cmluZ1tdIHwgbnVsbCkge1xuXHRjb25zdCB7IENMSUVuZ2luZSB9ID0gYXdhaXQgaW1wb3J0KGpvaW4ocHJvY2Vzcy5jd2QoKSwgJ25vZGVfbW9kdWxlcy9lc2xpbnQnKSkgYXMgdHlwZW9mIGltcG9ydCgnZXNsaW50Jyk7XG5cdGNvbnN0IGNsaSA9IG5ldyBDTElFbmdpbmUoe1xuXHRcdGV4dGVuc2lvbnM6IFsuLi5FWFRFTlNJT05TXSxcblx0XHRpZ25vcmVQYXRoOiAnLmdpdGlnbm9yZSdcblx0fSk7XG5cdGNvbnN0IHJlcG9ydCA9IGNsaS5leGVjdXRlT25GaWxlcyhmaWxlcyB8fCBbJ3NyYyddKTtcblx0Y29uc3QgeyByZXN1bHRzLCBlcnJvckNvdW50LCB3YXJuaW5nQ291bnQgfSA9IHJlcG9ydDtcblx0Y29uc3QgbGV2ZWxzOiBDaGVja3NVcGRhdGVQYXJhbXNPdXRwdXRBbm5vdGF0aW9uc1snYW5ub3RhdGlvbl9sZXZlbCddW10gPSBbJ25vdGljZScsICd3YXJuaW5nJywgJ2ZhaWx1cmUnXTtcblx0Y29uc3QgYW5ub3RhdGlvbnM6IENoZWNrc1VwZGF0ZVBhcmFtc091dHB1dEFubm90YXRpb25zW10gPSBbXTtcblx0Y29uc3QgY29uc29sZU91dHB1dDogc3RyaW5nW10gPSBbXTtcblx0Y29uc3QgY29uc29sZUxldmVscyA9IFssICd3YXJuaW5nJywgJ2Vycm9yJ107XG5cdGZvciAoY29uc3QgcmVzIG9mIHJlc3VsdHMpIHtcblx0XHRjb25zdCB7IGZpbGVQYXRoLCBtZXNzYWdlcyB9ID0gcmVzO1xuXHRcdGNvbnN0IHBhdGggPSBmaWxlUGF0aC5zdWJzdHJpbmcoR0lUSFVCX1dPUktTUEFDRSEubGVuZ3RoICsgMSk7XG5cdFx0Zm9yIChjb25zdCBtc2cgb2YgbWVzc2FnZXMpIHtcblx0XHRcdGNvbnN0IHsgbGluZSwgZW5kTGluZSwgY29sdW1uLCBlbmRDb2x1bW4sIHNldmVyaXR5LCBydWxlSWQsIG1lc3NhZ2UgfSA9IG1zZztcblx0XHRcdGNvbnN0IGFubm90YXRpb25MZXZlbCA9IGxldmVsc1tzZXZlcml0eV07XG5cdFx0XHRjb25zdCBjb25zb2xlTGV2ZWwgPSBjb25zb2xlTGV2ZWxzW3NldmVyaXR5XTtcblx0XHRcdGFubm90YXRpb25zLnB1c2goe1xuXHRcdFx0XHRwYXRoLFxuXHRcdFx0XHRzdGFydF9saW5lOiBsaW5lLFxuXHRcdFx0XHRlbmRfbGluZTogZW5kTGluZSB8fCBsaW5lLFxuXHRcdFx0XHRzdGFydF9jb2x1bW46IGNvbHVtbixcblx0XHRcdFx0ZW5kX2NvbHVtbjogZW5kQ29sdW1uIHx8IGNvbHVtbixcblx0XHRcdFx0YW5ub3RhdGlvbl9sZXZlbDogYW5ub3RhdGlvbkxldmVsLFxuXHRcdFx0XHR0aXRsZTogcnVsZUlkIHx8IEFDVElPTl9OQU1FLFxuXHRcdFx0XHRtZXNzYWdlOiBgJHttZXNzYWdlfSR7cnVsZUlkID8gYFxcbmh0dHBzOi8vZXNsaW50Lm9yZy9kb2NzL3J1bGVzLyR7cnVsZUlkfWAgOiAnJ31gXG5cdFx0XHR9KTtcblx0XHRcdGNvbnNvbGVPdXRwdXQucHVzaChgJHtwYXRofVxcbmApO1xuXHRcdFx0Y29uc29sZU91dHB1dC5wdXNoKGAjI1ske2NvbnNvbGVMZXZlbH1dICAke2xpbmV9OiR7Y29sdW1ufSAgJHtjb25zb2xlTGV2ZWx9ICAke21lc3NhZ2V9ICAke3J1bGVJZH1cXG5cXG5gKTtcblx0XHR9XG5cdH1cblx0Y29uc29sZS5sb2coY29uc29sZU91dHB1dC5qb2luKCcnKSk7XG5cblx0cmV0dXJuIHtcblx0XHRjb25jbHVzaW9uOiBlcnJvckNvdW50ID4gMCA/ICdmYWlsdXJlJyA6ICdzdWNjZXNzJyBhcyBDaGVja3NDcmVhdGVQYXJhbXNbJ2NvbmNsdXNpb24nXSxcblx0XHRvdXRwdXQ6IHtcblx0XHRcdHRpdGxlOiBBQ1RJT05fTkFNRSxcblx0XHRcdHN1bW1hcnk6IGAke2Vycm9yQ291bnR9IGVycm9yKHMpLCAke3dhcm5pbmdDb3VudH0gd2FybmluZyhzKSBmb3VuZGAsXG5cdFx0XHRhbm5vdGF0aW9uc1xuXHRcdH1cblx0fTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gcnVuKCkge1xuXHRjb25zdCBvY3Rva2l0ID0gbmV3IEdpdEh1YihHSVRIVUJfVE9LRU4hKTtcblxuXHRsZXQgY3VycmVudFNoYTogc3RyaW5nO1xuXHRsZXQgaW5mbztcblx0bGV0IGxpbnRGaWxlcztcblx0aWYgKGNvbnRleHQuaXNzdWUgJiYgY29udGV4dC5pc3N1ZS5udW1iZXIpIHtcblx0XHRpbmZvID0gYXdhaXQgb2N0b2tpdC5ncmFwaHFsKGBxdWVyeSgkb3duZXI6IFN0cmluZyEsICRuYW1lOiBTdHJpbmchLCAkcHJOdW1iZXI6IEludCEpIHtcblx0XHRcdHJlcG9zaXRvcnkob3duZXI6ICRvd25lciwgbmFtZTogJG5hbWUpIHtcblx0XHRcdFx0cHVsbFJlcXVlc3QobnVtYmVyOiAkcHJOdW1iZXIpIHtcblx0XHRcdFx0XHRmaWxlcyhmaXJzdDogMTAwKSB7XG5cdFx0XHRcdFx0XHRub2RlcyB7XG5cdFx0XHRcdFx0XHRcdHBhdGhcblx0XHRcdFx0XHRcdH1cblx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0Y29tbWl0cyhsYXN0OiAxKSB7XG5cdFx0XHRcdFx0XHRub2RlcyB7XG5cdFx0XHRcdFx0XHRcdGNvbW1pdCB7XG5cdFx0XHRcdFx0XHRcdFx0b2lkXG5cdFx0XHRcdFx0XHRcdH1cblx0XHRcdFx0XHRcdH1cblx0XHRcdFx0XHR9XG5cdFx0XHRcdH1cblx0XHRcdH1cblx0XHR9YCxcblx0XHR7XG5cdFx0XHRvd25lcjogY29udGV4dC5yZXBvLm93bmVyLFxuXHRcdFx0bmFtZTogY29udGV4dC5yZXBvLnJlcG8sXG5cdFx0XHRwck51bWJlcjogY29udGV4dC5pc3N1ZS5udW1iZXJcblx0XHR9KTtcblx0XHRjdXJyZW50U2hhID0gaW5mby5yZXBvc2l0b3J5LnB1bGxSZXF1ZXN0LmNvbW1pdHMubm9kZXNbMF0uY29tbWl0Lm9pZDtcblx0XHRjb25zdCBmaWxlcyA9IGluZm8ucmVwb3NpdG9yeS5wdWxsUmVxdWVzdC5maWxlcy5ub2Rlcztcblx0XHRsaW50RmlsZXMgPSBmaWxlcy5maWx0ZXIoKGZpbGU6IHsgcGF0aDogc3RyaW5nIH0pID0+IEVYVEVOU0lPTlMuaGFzKGV4dG5hbWUoZmlsZS5wYXRoKSkgJiYgIWZpbGUucGF0aC5pbmNsdWRlcygnLmQudHMnKSkubWFwKChmOiB7IHBhdGg6IHN0cmluZyB9KSA9PiBmLnBhdGgpO1xuXHR9IGVsc2Uge1xuXHRcdGluZm8gPSBhd2FpdCBvY3Rva2l0LnJlcG9zLmdldENvbW1pdCh7IG93bmVyOiBjb250ZXh0LnJlcG8ub3duZXIsIHJlcG86IGNvbnRleHQucmVwby5yZXBvLCByZWY6IEdJVEhVQl9TSEEhIH0pO1xuXHRcdGN1cnJlbnRTaGEgPSBHSVRIVUJfU0hBITtcblx0XHRjb25zdCBmaWxlcyA9IGluZm8uZGF0YS5maWxlcztcblx0XHRsaW50RmlsZXMgPSBmaWxlcy5maWx0ZXIoZmlsZSA9PiBFWFRFTlNJT05TLmhhcyhleHRuYW1lKGZpbGUuZmlsZW5hbWUpKSAmJiAhZmlsZS5maWxlbmFtZS5pbmNsdWRlcygnLmQudHMnKSAmJiBmaWxlLnN0YXR1cyAhPT0gJ3JlbW92ZWQnICYmIGZpbGUuc3RhdHVzICE9PSAnY2hhbmdlZCcpLm1hcChmID0+IGYuZmlsZW5hbWUpO1xuXHR9XG5cdGRlYnVnKGBDb21taXQ6ICR7Y3VycmVudFNoYX1gKTtcblxuXHRsZXQgaWQ6IG51bWJlciB8IHVuZGVmaW5lZDtcblx0Y29uc3Qgam9iTmFtZSA9IGdldElucHV0KCdqb2ItbmFtZScpO1xuXHRpZiAoam9iTmFtZSkge1xuXHRcdGNvbnN0IGNoZWNrcyA9IGF3YWl0IG9jdG9raXQuY2hlY2tzLmxpc3RGb3JSZWYoe1xuXHRcdFx0Li4uY29udGV4dC5yZXBvLFxuXHRcdFx0c3RhdHVzOiAnaW5fcHJvZ3Jlc3MnLFxuXHRcdFx0cmVmOiBjdXJyZW50U2hhXG5cdFx0fSk7XG5cdFx0Y29uc3QgY2hlY2sgPSBjaGVja3MuZGF0YS5jaGVja19ydW5zLmZpbmQoKHsgbmFtZSB9KSA9PiBuYW1lLnRvTG93ZXJDYXNlKCkgPT09IGpvYk5hbWUudG9Mb3dlckNhc2UoKSk7XG5cdFx0aWYgKGNoZWNrKSBpZCA9IGNoZWNrLmlkO1xuXHR9XG5cdGlmICghaWQpIHtcblx0XHRpZCA9IChhd2FpdCBvY3Rva2l0LmNoZWNrcy5jcmVhdGUoe1xuXHRcdFx0Li4uY29udGV4dC5yZXBvLFxuXHRcdFx0bmFtZTogQUNUSU9OX05BTUUsXG5cdFx0XHRoZWFkX3NoYTogY3VycmVudFNoYSxcblx0XHRcdHN0YXR1czogJ2luX3Byb2dyZXNzJyxcblx0XHRcdHN0YXJ0ZWRfYXQ6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKVxuXHRcdH0pKS5kYXRhLmlkO1xuXHR9XG5cblx0dHJ5IHtcblx0XHRjb25zdCBsaW50QWxsID0gZ2V0SW5wdXQoJ2xpbnQtYWxsJyk7XG5cdFx0Y29uc3QgeyBjb25jbHVzaW9uLCBvdXRwdXQgfSA9IGF3YWl0IGxpbnQobGludEFsbCA/IG51bGwgOiBsaW50RmlsZXMpO1xuXHRcdGF3YWl0IG9jdG9raXQuY2hlY2tzLnVwZGF0ZSh7XG5cdFx0XHQuLi5jb250ZXh0LnJlcG8sXG5cdFx0XHRjaGVja19ydW5faWQ6IGlkLFxuXHRcdFx0Y29tcGxldGVkX2F0OiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCksXG5cdFx0XHRjb25jbHVzaW9uLFxuXHRcdFx0b3V0cHV0XG5cdFx0fSk7XG5cdFx0ZGVidWcob3V0cHV0LnN1bW1hcnkpO1xuXHRcdGlmIChjb25jbHVzaW9uID09PSAnZmFpbHVyZScpIHNldEZhaWxlZChvdXRwdXQuc3VtbWFyeSk7XG5cdH0gY2F0Y2ggKGVycm9yKSB7XG5cdFx0YXdhaXQgb2N0b2tpdC5jaGVja3MudXBkYXRlKHtcblx0XHRcdC4uLmNvbnRleHQucmVwbyxcblx0XHRcdGNoZWNrX3J1bl9pZDogaWQsXG5cdFx0XHRjb25jbHVzaW9uOiAnZmFpbHVyZScsXG5cdFx0XHRjb21wbGV0ZWRfYXQ6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKVxuXHRcdH0pO1xuXHRcdHNldEZhaWxlZChlcnJvci5tZXNzYWdlKTtcblx0fVxufVxuXG5ydW4oKTtcbiJdfQ==